<h1 style="font-size: 250%;">ロボットシステム学</h1>-c-c-c-<h2>第5回</h2>-c-c-c-上田 隆一-c-c-c--c-c-c-2016年10月26日\@千葉工業大学-c-c-c--c-c-c-<!--nextpage-->-c-c-c-<h2>今日の内容</h2>-c-c-c-<ul>-c-c-c- 	<li>ファイルシステムとデバイス</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>ファイルシステム</h2>-c-c-c-<ul>-c-c-c- 	<li>OS の最重要機能の一つ</li>-c-c-c- 	<li>機能-c-c-c-<ul>-c-c-c- 	<li>誰にでも分かりやすいもの</li>-c-c-c- 	<li>HDDを使えるようにする</li>-c-c-c- 	<li>USBメモリを使えるようにする</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>人によっては意外なもの-c-c-c-<ul>-c-c-c- 	<li>外部の機器（センサ等）を使えるようにする</li>-c-c-c- 	<li>OS と通信する</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>ローカルファイルシステム</h2>-c-c-c-<ul>-c-c-c- 	<li>ストレージ側のファイルシステム-c-c-c-<ul>-c-c-c- 	<li>何百万、何百兆のゼロイチの並びのどこにファイル・ディレクトリ、その他メタデータ等を置くかを規定・実現</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>主なファイルシステム-c-c-c-<ul style="font-size: 80%;">-c-c-c- 	<li>ext4, ext3, (extended file system): Linux</li>-c-c-c- 	<li>UFS2 (UNIX File System2): FreeBSD</li>-c-c-c- 	<li>HFS+ (Hierarchical File System Plus): Mac OS X</li>-c-c-c- 	<li>NTFS (NT File System), FAT16, FAT32, exFAT: Windows</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>特殊なファイルシステム-c-c-c-<ul>-c-c-c- 	<li>procfs, sysfs, tmpfs, スワップファイルシステム</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>ストレージにデータを書く仕組み</h2>-c-c-c-<ul>-c-c-c- 	<li>ストレージがあったら、いくつかのパーティションに分け、それぞれの形式でファイルシステムをフォーマットして使う</li>-c-c-c- 	<li>ストレージの区分け-c-c-c-<ul>-c-c-c- 	<li>パーティション[latex]\\rightarrow[/latex]ローカルファイルシステム[latex]\\rightarrow[/latex]ブロックグループ[latex]\\rightarrow[/latex]ブロック</li>-c-c-c- 	<li>注意: HDD 自体にもセクタ、トラック、シリンダーという階層構造があるが、それは別の話</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>パーティションの確認</h2>-c-c-c-<ul>-c-c-c- 	<li><span style="color: #0000ff;">$ sudo parted -l</span>-c-c-c-<pre><span style="color: #ffffff;">Model: SD SA16G (sd/mmc)</span>-c-c-c-<span style="color: #ffffff;">Disk /dev/mmcblk0: 15.6GB</span>-c-c-c-<span style="color: #ffffff;">Sector size (logical/physical): 512B/512B</span>-c-c-c-<span style="color: #ffffff;">Partition Table: msdos</span>-c-c-c-<span style="color: #ffffff;">Disk Flags:</span>-c-c-c--c-c-c-<span style="color: #ffffff;">Number  Start   End     Size    Type      File system  Flags</span>-c-c-c-<span style="color: #ffffff;">1      4194kB  1089MB  1085MB  primary   fat32        lba</span>-c-c-c-<span style="color: #ffffff;">2      1091MB  15.6GB  14.5GB  extended</span>-c-c-c-<span style="color: #ffffff;">5      1095MB  1158MB  62.9MB  logical   fat16        lba</span>-c-c-c-<span style="color: #ffffff;">6      1162MB  15.6GB  14.5GB  logical   ext4</span>-c-c-c-<span style="color: #ffffff;">3      15.6GB  15.6GB  33.6MB  primary   ext4</span></pre>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>iノード、ディレクトリ</h2>-c-c-c-<ul>-c-c-c- 	<li>ファイルを管理するためのデータ</li>-c-c-c- 	<li>iノード番号: ファイルやディレクトリ（これもファイル）の固有番号-c-c-c-<ul>-c-c-c- 	<li>-c-c-c-<p class="p1"><span class="s1" style="color: #0000ff;">$ ls -i <span style="color: #333333;">で、iノード番号が表示できる</span></span></p>-c-c-c-</li>-c-c-c- 	<li>-c-c-c-<p class="p1">ディレクトリもファイルなので当然iノード番号を持つ</p>-c-c-c-</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>ディレクトリ-c-c-c-<ul>-c-c-c- 	<li>ディレクトリエントリのリストの管理</li>-c-c-c- 	<li>ディレクトリエントリ-c-c-c-<ul>-c-c-c- 	<li>ファイルのiノードと名前</li>-c-c-c- 	<li>（ファイル名を変えても変わるのはファイル本体ではない）</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2 class="p1">仮想ファイルシステム（<span class="s1">VFS</span>）</h2>-c-c-c-<ul>-c-c-c- 	<li>主な役割-c-c-c-<ul>-c-c-c- 	<li>ローカルファイルシステムの違いを吸収-c-c-c-<ul>-c-c-c- 	<li>write,read 等のシステムコールが呼ばれると各フォーマット用の関数に変換される</li>-c-c-c- 	<li>i ノードという概念がないローカルファイルシステムもi ノードをなんとか再現</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>機能-c-c-c-<ul>-c-c-c- 	<li>メモリ上にi ノード（inode 構造体）やディレクトリエントリ（dentry 構造体）を展開してユーザプログラムとやりとり</li>-c-c-c- 	<li>データブロックの内容をメモリ上に保持（キャッシュ）</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>パーティションの作成</h2>-c-c-c-<ul>-c-c-c- 	<li>partedコマンドを作成-c-c-c-<ul>-c-c-c- 	<li>例/dev/sdcに見えるUSBメモリをext4でフォーマット</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">$ sudo parted /dev/sdc</span>-c-c-c-<span style="color: #ffffff;">GNU Parted 3.2</span>-c-c-c-<span style="color: #ffffff;">Using /dev/sdc</span>-c-c-c-<span style="color: #ffffff;">Welcome to GNU Parted! Type 'help' to view a list of commands.</span>-c-c-c-<span style="color: #ffffff;">(parted) mklabel gpt                                                      </span>-c-c-c-<span style="color: #ffffff;">(parted) unit GB                                                          </span>-c-c-c-<span style="color: #ffffff;">(parted) print                                                            </span>-c-c-c-<span style="color: #ffffff;">Model: TOSHIBA TransMemory-Mx (scsi)</span>-c-c-c-<span style="color: #ffffff;">Disk /dev/sdc: 62.4GB</span>-c-c-c-<span style="color: #ffffff;">Sector size (logical/physical): 512B/512B</span>-c-c-c-<span style="color: #ffffff;">Partition Table: gpt</span>-c-c-c-<span style="color: #ffffff;">Disk Flags:</span>-c-c-c--c-c-c-<span style="color: #ffffff;">Number  Start  End  Size  File system  Name  Flags</span></pre>-c-c-c-&nbsp;-c-c-c--c-c-c-<!--nextpage-->-c-c-c-<ul>-c-c-c- 	<li>続き-c-c-c-<ul>-c-c-c- 	<li>パーティションを作ったらext4でフォーマット</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<pre class="p1"><span class="s1" style="color: #ffffff;">(parted) mkpart</span>-c-c-c-<span class="s1" style="color: #ffffff;">Partition name?<span class="Apple-converted-space">  </span>[]? data1 <span class="Apple-converted-space">                                               </span></span>-c-c-c-<span class="s1" style="color: #ffffff;">File system type?<span class="Apple-converted-space">  </span>[ext2]? ext4</span>-c-c-c-<span class="s1" style="color: #ffffff;">Start? 0 <span class="Apple-converted-space">                                                                 </span></span>-c-c-c-<span class="s1" style="color: #ffffff;">End? 62.4<span class="Apple-converted-space">                                                                 </span></span>-c-c-c-<span class="s1" style="color: #ffffff;">(parted)<span class="Apple-converted-space">   q-c-c-c-</span>$</span><span class="s2"><span style="color: #ffffff;"> mkfs.ext4 /dev/sdc1</span> </span></pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>マウント・アンマウント</h2>-c-c-c-<ul>-c-c-c- 	<li>既存のディレクトリにファイルシステムをぶら下げる-c-c-c-<ul>-c-c-c- 	<li>どこにでもぶら下げられる</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>例: ~/tmpにさっきのUSBメモリのパーティションをぶら下げる-c-c-c-<ul>-c-c-c- 	<li>注意: ~/tmpの中でやると話がややこしくなるので~/で作業を</li>-c-c-c- 	<li>-c-c-c-<pre class="p1"><span style="color: #ffffff;"><span class="s1">$</span><span class="s2"> echo aaa &gt; ~/tmp/file1    #元のところにファイルを作っておきましょう-c-c-c-</span><span class="s1">$</span><span class="s3"> ls ~/tmp-c-c-c- </span><span class="s2">file1-c-c-c-</span><span class="s1">$</span><span class="s2"> sudo mount /dev/sdc1 ./-c-c-c-</span><span class="s1">$</span><span class="s2"> sudo mount /dev/sdc1 ~/tmp   #マウント-c-c-c-</span><span class="s1">$</span><span class="s3"> ls ~/tmp/             #~/tmpが差しているディレクトリが変わる-c-c-c- </span><span class="s2">lost+found</span></span></pre>-c-c-c-</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<ul>-c-c-c- 	<li>続き</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;"><span class="s1">$</span><span class="s2"> df</span></span>-c-c-c-<span class="s2" style="color: #ffffff;">ファイルシス <span class="Apple-converted-space">  </span>1K-ブロック<span class="Apple-converted-space">      </span>使用 <span class="Apple-converted-space">    </span>使用可 使用% マウント位置</span>-c-c-c-<span style="color: #ffffff;">（中略）</span>-c-c-c-<span style="color: #ffffff;">/dev/sdc1         59871340     53064   56753856    1% /home/ueda/tmp-c-c-c-$<span class="s2"> sudo umount ~/tmp #アンマウント-c-c-c-</span><span class="s1">$</span><span class="s3"> ls ~/tmp/ #元に戻る</span>-c-c-c-<span class="s2">file1</span></span></pre>-c-c-c-<p class="p1"><!--nextpage--></p>-c-c-c--c-c-c-<h2 class="p1">擬似ファイルシステム</h2>-c-c-c-<ul>-c-c-c- 	<li>仮想ファイルシステムとやりとりして機器の機能や</li>-c-c-c- 	<li>OS 内部の情報を提供</li>-c-c-c- 	<li>主要なもの-c-c-c-<ul>-c-c-c- 	<li>devtmpfs（/dev/）: デバイスファイル置き場</li>-c-c-c- 	<li>procfs（/proc/）: プロセスの情報＋その他OS の情報</li>-c-c-c- 	<li>sysfs（/sys/）: OSの情報（/proc/が混乱したのでこちらに移動）</li>-c-c-c- 	<li>tmpfs（/run/shm/）: DRAM 上にファイルを置く仕組み</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<p class="p1"><!--nextpage--></p>-c-c-c--c-c-c-<h2>デバイスドライバ・-c-c-c-デバイスファイル</h2>-c-c-c-<ul>-c-c-c- 	<li>デバイスドライバ-c-c-c-<ul>-c-c-c- 	<li>計算機に接続された機器を操作するためのプログラム-c-c-c-<ul>-c-c-c- 	<li>HDD、ディスプレイ、カメラ、マイク、端末、 ...</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>デバイスファイル-c-c-c-<ul>-c-c-c- 	<li>デバイスドライバのインタフェース</li>-c-c-c- 	<li>ファイルとして表現されている-c-c-c-<ul>-c-c-c- 	<li>機械と言えども、結局データをin/outするという点でファイルとして抽象化可能</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>/dev/の下に存在</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>/dev/下のファイル</h2>-c-c-c-<ul>-c-c-c- 	<li><span style="color: #0000ff;"><span class="s1">$</span><span class="s2"> ls -l /dev/</span></span>-c-c-c-<ul style="font-size: 80%;">-c-c-c- 	<li>日付右側の数字（10, 58 等）: デバイスの番号-c-c-c-<ul>-c-c-c- 	<li>メジャー番号（左側）: デバイスドライバ固有の番号</li>-c-c-c- 	<li>マイナー番号（右側）: デバイスドライバの中で与えられる番号</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>ブロックデバイス、キャラクタデバイスの判別-c-c-c-<ul style="font-size: 80%;">-c-c-c- 	<li>パーミッション前の文字（b: ブロック、c: キャラクタ）</li>-c-c-c- 	<li>ブロックデバイス: データをブロック（塊）単位で読み書き</li>-c-c-c- 	<li>キャラクタデバイス: データをシーケンシャルに出し入れ</li>-c-c-c- 	<li>もう一つ、「ネットワークデバイス」（ eth0等のあれ）があるがLinuxでは別扱い</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>デバイスドライバ</h2>-c-c-c-<ul>-c-c-c- 	<li>カーネルの一部として動作-c-c-c-<ul>-c-c-c- 	<li>Cで言えばmainを持たない関数の塊</li>-c-c-c- 	<li>本来はカーネルと同時にコンパイルされるべき</li>-c-c-c- 	<li>ただしそれをやってしまうと時間や手間の無駄</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>Linuxにはカーネルの一部を動的に脱着する仕組みが存在-c-c-c-<ul>-c-c-c- 	<li>カーネルの一部: カーネルモジュール（拡張子 .ko）</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>カーネルモジュールの調査</h2>-c-c-c-<ul>-c-c-c- 	<li>ファイルの検索-c-c-c-<ul>-c-c-c- 	<li>-c-c-c-<pre class="p1"><span style="color: #ffffff;"><span class="s1">$</span><span class="s2"> sudo find / | grep '\\.ko$'</span></span></pre>-c-c-c-</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>今使われているカーネルモジュールはlsmodで調査-c-c-c-<ul>-c-c-c- 	<li>-c-c-c-<pre><span style="color: #ffffff;">$ lsmod</span>-c-c-c-<span style="color: #ffffff;">Module                  Size  Used by</span>-c-c-c-<span style="color: #ffffff;">binfmt_misc             6388  1 </span>-c-c-c-<span style="color: #ffffff;">bnep                   10340  2 </span>-c-c-c-<span style="color: #ffffff;">hci_uart               17943  1 </span>-c-c-c-<span style="color: #ffffff;">btbcm                   5929  1 hci_uart</span>-c-c-c-<span style="color: #ffffff;">bluetooth             326067  22 bnep,btbcm,hci_uart</span>-c-c-c-<span style="color: #ffffff;">（以下略）</span></pre>-c-c-c-</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>カーネルモジュールの脱着</h2>-c-c-c-<ul>-c-c-c- 	<li>insmod, rmmod-c-c-c-<ul>-c-c-c- 	<li>他にmodplobe</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>例:-c-c-c-<ul>-c-c-c- 	<li>-c-c-c-<pre class="p1"><span style="color: #ffffff;"><span class="s2">$ lsmod-c-c-c-（中略）-c-c-c-</span><span class="s1">i2c_dev <span class="Apple-converted-space">                </span>5859<span class="Apple-converted-space">  </span>0 -c-c-c-（略）-c-c-c-$<span class="s2"> sudo rmmod i2c_dev-c-c-c-$ lsmod | grep i2c-c-c-c-$ -c-c-c-</span></span><span class="s1">$</span><span class="s2"> sudo insmod /usr/src/linux/drivers/i2c/i2c-dev.ko-c-c-c-$ lsmod-c-c-c-Module                  Size  Used by-c-c-c-i2c_dev                 5859  0 -c-c-c-（以下略）</span></span></pre>-c-c-c-</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>insmodすると/sys/下で情報が見られるようになるので興味のある人は調査を-c-c-c-<ul>-c-c-c- 	<li>あとでカーネルモジュールを書くときにやります</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>デバイスドライバを作る</h2>-c-c-c-<ul>-c-c-c- 	<li>来週から2週にかけて取り組みます</li>-c-c-c- 	<li>デバイスドライバを作る時の制限-c-c-c-<ul>-c-c-c- 	<li>カーネルモジュールはカーネルの一部なので、今動いているカーネルと整合性がないと動かない</li>-c-c-c- 	<li>今動いているカーネルのバージョンにあったLinuxのヘッダファイルが必要</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>Raspberry Piの場合-c-c-c-<ul>-c-c-c- 	<li>基本的に自分でLinuxのソースコードをダウンロードして、一度カーネルを作るのが面倒なようで手っ取り早い-c-c-c-<ul>-c-c-c- 	<li>これで整合性のあるヘッダファイルが得られる</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>カーネルの再構築（宿題）</h2>-c-c-c-<ul>-c-c-c- 	<li>LinuxをGitHubからクローンしてビルドしてカーネルを作ります</li>-c-c-c- 	<li>手順-c-c-c-<ol>-c-c-c- 	<li>-c-c-c-<pre><span style="color: #ffffff;">$ git clone https://github.com/ryuichiueda/raspberry_pi_kernel_build_scripts.git</span>-c-c-c-<span style="color: #ffffff;">$ cd raspberry_pi_kernel_build_scripts</span>-c-c-c-<span style="color: #ffffff;">$ sudo ./kernel_build_and_install_for_pi2_pi3.bash</span>-c-c-c-<span style="color: #ffffff;">$ sudo reboot</span></pre>-c-c-c-</li>-c-c-c-</ol>-c-c-c-</li>-c-c-c- 	<li>この作業で使ったシェルスクリプト「<a href="https://github.com/ryuichiueda/raspberry_pi_kernel_build_scripts/blob/master/kernel_build_and_install_for_pi2_pi3.bash" target="_blank">kernel_build_and_install_for_pi2_pi3.bash</a><span style="color: #333333;">」</span></li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>カーネルの入れ替わりの確認</h2>-c-c-c-<ul>-c-c-c- 	<li>uname -aでビルドされた日時を確認</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">pi\@raspberrypi:~ $ uname -a-c-c-c-Linux raspberrypi 4.4.22-v7+ #1 SMP Mon Sep 26 13:11:18 JST 2016 armv7l GNU/Linux</span></pre>-c-c-c-&nbsp;
