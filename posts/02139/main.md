<h1 style="font-size: 250%;">ロボットシステム学</h1>-c-c-c-<h2>第6回</h2>-c-c-c-上田 隆一-c-c-c--c-c-c-2016年11月2日\@千葉工業大学-c-c-c--c-c-c-<!--nextpage-->-c-c-c-<h2>今日の内容</h2>-c-c-c-<ul>-c-c-c- 	<li>デバイスドライバを作る</li>-c-c-c- 	<li>次回はGPIOの操作に挑戦しますが、今回はPCの中で完結する話-c-c-c-<ul>-c-c-c- 	<li>仮想マシンでもOK</li>-c-c-c- 	<li>RaspbianとUbuntuでは少しやり方が違う</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>回路の例<a href="https://lab.ueda.asia/wp-content/uploads/2016/09/gpio25.jpg"><img class="alignright size-medium wp-image-1706" src="https://lab.ueda.asia/wp-content/uploads/2016/09/gpio25-300x225.jpg" alt="gpio25" width="300" height="225" /></a></h2>-c-c-c-<ul>-c-c-c- 	<li>GPIO25とGNDの間にLEDを接続-c-c-c-<ul>-c-c-c- 	<li>GPIO25: 22番ピン</li>-c-c-c- 	<li>GND: 39番ピン</li>-c-c-c- 	<li>LEDのアノード（足の長い方）をGPIO25に</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>抵抗はなくても特に問題ない-c-c-c-<ul>-c-c-c- 	<li>抵抗をつなぐとLEDに優しい</li>-c-c-c- 	<li>抵抗をつなぐ場合は200-300Ω程度（適当）</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>最初のコード</h2>-c-c-c-<ul>-c-c-c- 	<li>適当なディレクトリを作ってその中に</li>-c-c-c- 	<li>ファイル名は「myled.c」にしましょう</li>-c-c-c- 	<li>コードの中身-c-c-c-<ul>-c-c-c- 	<li>カーネルモジュールの初期化と後始末の関数を書く</li>-c-c-c- 	<li>マクロに関数名を与える</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">#include &lt;linux/module.h&gt;-c-c-c--c-c-c-static int __init init_mod(void)-c-c-c-{-c-c-c- return 0;-c-c-c-}-c-c-c--c-c-c-static void __exit cleanup_mod(void)-c-c-c-{-c-c-c-}-c-c-c--c-c-c-module_init(init_mod);-c-c-c-module_exit(cleanup_mod);-c-c-c-</span></pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>Makefileを書く</h2>-c-c-c-<ul>-c-c-c- 	<li>Makefileという名前のファイルを作って次のように書く</li>-c-c-c- 	<li><span style="color: #ff0000;">インデントはタブで</span></li>-c-c-c- 	<li>Makefileのごくごく簡単な説明-c-c-c-<ul style="font-size: 80%;">-c-c-c- 	<li>&lt;作りたいファイル or 行いたい処理&gt;: &lt;必要なファイル&gt;と書いてその下に実行するコマンドを書く</li>-c-c-c- 	<li>コロンの左側をターゲットと言う</li>-c-c-c- 	<li>makeと打つと最初に書いてあるターゲットの作成が試みられる</li>-c-c-c- 	<li>必要なファイルがないと、ないファイルのターゲットの処理が試みられる</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<pre class="p1"><span class="s1" style="color: #ffffff;">obj-m:= myled.o #オブジェクトファイルの名前を指定（拡張子はo）</span>-c-c-c--c-c-c-<span class="s1" style="color: #ffffff;">myled.ko: myled.c </span>-c-c-c-<span class="s1" style="color: #ffffff;"> make -C /usr/src/linux M=`pwd` V=1 modules #makeと打つと実行される</span>-c-c-c-<span class="s1" style="color: #ffffff;">clean:</span>-c-c-c-<span class="s1" style="color: #ffffff;"> make -C /usr/src/linux M=`pwd` V=1 clean #make cleanで実行</span></pre>-c-c-c-&nbsp;-c-c-c--c-c-c-<!--nextpage-->-c-c-c-<h2>コンパイルと実行、インストール</h2>-c-c-c-<pre><span style="color: #ffffff;">$ make #Makefileとmyled.cが正しければこれでOK</span>-c-c-c-<span style="color: #ffffff;">$ ls #確認</span>-c-c-c-<span class="s1"><span style="color: #ffffff;">Makefile<span class="Apple-converted-space">  </span>Module.symvers<span class="Apple-converted-space">  </span>modules.order<span class="Apple-converted-space">  </span>myled.c<span class="Apple-converted-space">  </span>myled.ko<span class="Apple-converted-space">  </span>myled.mod.c<span class="Apple-converted-space">  </span>myled.mod.o<span class="Apple-converted-space">  </span>myled.o-c-c-c-$ sudo insmod myled.ko-c-c-c-</span></span><span style="color: #ffffff;"><span class="s1">$</span><span class="s2"> lsmod-c-c-c-</span><span class="s2">Module<span class="Apple-converted-space">                  </span>Size<span class="Apple-converted-space">  </span>Used by-c-c-c-</span><span class="s2">myled<span class="Apple-converted-space">                    </span>735<span class="Apple-converted-space">  </span>0 -c-c-c-...</span></span></pre>
