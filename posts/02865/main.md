<h2></h2>-c-c-c-<h1 style="font-size: 250%;">ロボットシステム学</h1>-c-c-c-<h2>第13回</h2>-c-c-c-上田 隆一-c-c-c--c-c-c-2017年1月18日\@千葉工業大学-c-c-c--c-c-c-<!--nextpage-->-c-c-c-<h2>本日の内容</h2>-c-c-c-<ul>-c-c-c- 	<li>ROS-c-c-c-<ul>-c-c-c- 	<li>ROSのインストールが終わった状態からスタート</li>-c-c-c- 	<li>ノード間の通信</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<h2></h2>-c-c-c-<!--nextpage-->-c-c-c-<h2>動作確認</h2>-c-c-c-<ul>-c-c-c- 	<li>$ roscore-c-c-c-<ul>-c-c-c- 	<li>ROSのバックにいるプログラムが立ち上がる</li>-c-c-c- 	<li>Ctrl+cで出る</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">$ roscore</span>-c-c-c-<span style="color: #ffffff;">（略）</span>-c-c-c-<span style="color: #ffffff;">started roslaunch server http://localhost:39310/</span>-c-c-c-<span style="color: #ffffff;">ros_comm version 1.12.6</span>-c-c-c--c-c-c-<span style="color: #ffffff;">SUMMARY</span>-c-c-c-<span style="color: #ffffff;">========</span>-c-c-c--c-c-c-<span style="color: #ffffff;">PARAMETERS</span>-c-c-c-<span style="color: #ffffff;">* /rosdistro: kinetic</span>-c-c-c-<span style="color: #ffffff;">* /rosversion: 1.12.6</span>-c-c-c--c-c-c-<span style="color: #ffffff;">NODES</span>-c-c-c--c-c-c-<span style="color: #ffffff;">auto-starting new master</span>-c-c-c-<span style="color: #ffffff;">process[master]: started with pid [1439]</span>-c-c-c-<span style="color: #ffffff;">ROS_MASTER_URI=http://localhost:11311/</span>-c-c-c--c-c-c-<span style="color: #ffffff;">setting /run_id to b749a100-d0dc-11e5-a506-b827eb17cb96</span>-c-c-c-<span style="color: #ffffff;">process[rosout-1]: started with pid [1452]</span>-c-c-c-<span style="color: #ffffff;">started core service [/rosout]</span></pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>ROSのノード</h2>-c-c-c-<ul>-c-c-c- 	<li>プログラムのプロセス一つ一つが「ノード」と呼ばれる</li>-c-c-c- 	<li>ノードの例-c-c-c-<ul>-c-c-c- 	<li>cv_cameraとmjpeg_serverを立ち上げる（roscoreは立ち上げておく）</li>-c-c-c- 	<li>-c-c-c-<pre class="p1"><span class="s1"><span style="color: #ffffff;">$ rosrun cv_camera cv_camera_node</span> -c-c-c-</span><span class="s1"><span style="color: #ffffff;">$ rosrun mjpeg_server mjpeg_server</span> </span></pre>-c-c-c-</li>-c-c-c- 	<li>ノードの確認-c-c-c-<pre><span style="color: #ffffff;">$ rosnode list-c-c-c-<span class="s1">/cv_camera-c-c-c-</span><span class="s1">/mjpeg_server-c-c-c-</span><span class="s1">/rosout</span></span></pre>-c-c-c-</li>-c-c-c- 	<li>ディレクトリのように管理されている</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>トピック・メッセージ</h2>-c-c-c-<ul>-c-c-c- 	<li>今度はrostopic listと打ってみる</li>-c-c-c- 	<li>データをやり取りする口（トピック）が表示される</li>-c-c-c- 	<li>-c-c-c-<pre class="p1"><span class="s1" style="color: #ffffff;">$ rostopic list</span>-c-c-c-<span class="s1" style="color: #ffffff;">/cv_camera/camera_info</span>-c-c-c-<span class="s1" style="color: #ffffff;">/cv_camera/image_raw</span>-c-c-c-<span class="s1" style="color: #ffffff;">/rosout</span>-c-c-c-<span class="s1" style="color: #ffffff;">/rosout_agg</span></pre>-c-c-c-</li>-c-c-c- 	<li>トピックからデータを取り出す（先週もやりました）</li>-c-c-c- 	<li>-c-c-c-<pre class="p1"><span class="s1" style="color: #ffffff;">$ rostopic echo /cv_camera/image_raw</span></pre>-c-c-c-<ul>-c-c-c- 	<li>このデータは「メッセージ」と呼ばれる</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<h2><!--nextpage--></h2>-c-c-c-<h2>パブリッシャ・-c-c-c-サブスクライバ</h2>-c-c-c-<ul>-c-c-c- 	<li>各ノードがトピックを通じてメッセージを融通することで全体として仕事を行う</li>-c-c-c- 	<li>mjpeg_serverは/cv_camera/image_rawからカメラ画像を取得して、ブラウザに画像を配信</li>-c-c-c- 	<li>データを出す側が<span style="color: #ff0000;">パブリッシャ</span></li>-c-c-c- 	<li>データを受け取る側が<span style="color: #ff0000;">サブスクライバ</span></li>-c-c-c- 	<li>この構造でサブスクライバ側の柔軟な組み換えが可能に-c-c-c-<ul>-c-c-c- 	<li>ブラウザに配信するノード、顔検出をするノード、mp4に変換するノード・・・</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<h2><!--nextpage--></h2>-c-c-c-<h2>ROSプログラミングの準備</h2>-c-c-c-<ul>-c-c-c- 	<li>パブリッシャ、サブスクライバを作ってみましょう</li>-c-c-c- 	<li>その前に・・・</li>-c-c-c- 	<li>「ワークスペース」（作業場）を作る</li>-c-c-c- 	<li>-c-c-c-<pre class="p1"><span style="color: #ffffff;"><span class="s1">$ cd-c-c-c-$ mkdir -p catkin_ws/src-c-c-c-</span><span class="s1">$ cd ~/catkin_ws/src-c-c-c-</span><span class="s1">$ catkin_init_workspace -c-c-c-</span><span class="s1">Creating symlink "/home/ubuntu/catkin_ws/src/CMakeLists.txt" pointing to "/opt/ros/kinetic/share/catkin/cmake/toplevel.cmake"-c-c-c-</span><span class="s1">$ ls-c-c-c-</span><span class="s1">CMakeLists.txt</span></span></pre>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<h2><!--nextpage--></h2>-c-c-c-<ul>-c-c-c- 	<li>.bashrcの末尾に以下を記述</li>-c-c-c-</ul>-c-c-c-<pre class="p1"><span style="color: #ffffff;"><span class="s1">source</span><span class="s2"> /opt/ros/kinetic/setup.bash #これは元からある-c-c-c-</span><span class="s1">source</span><span class="s2"> ~/catkin_ws/devel/setup.bash #ここから3行追加</span></span>-c-c-c-<span style="color: #ffffff;"><span class="s1">export</span><span class="s3"> ROS_MASTER_URI=</span><span class="s2">http://localhost:</span><span class="s4">11311</span></span>-c-c-c-<span style="color: #ffffff;"><span class="s1">export</span><span class="s2"> ROS_HOSTNAME=</span><span class="s5">localhost-c-c-c-</span></span></pre>-c-c-c-<ul>-c-c-c- 	<li>環境のビルド</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">$ cd ~/catkin_ws</span>-c-c-c-<span class="s1" style="color: #ffffff;">$ catkin_make-c-c-c-$ source ~/.bashrc-c-c-c-</span></pre>-c-c-c-<ul>-c-c-c- 	<li>確認-c-c-c-<ul>-c-c-c- 	<li>ROS_PACKAGE_PATHにcatkin_ws/srcがセットされているはず</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">$ echo $ROS_PACKAGE_PATH</span>-c-c-c-<span class="s1" style="color: #ffffff;">/home/ubuntu/catkin_ws/src:/opt/ros/kinetic/share</span></pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>パッケージを作る</h2>-c-c-c-<ul>-c-c-c- 	<li>パッケージ: いくつかのノードを含んだ一単位</li>-c-c-c- 	<li>パッケージの生成-c-c-c-<ul>-c-c-c- 	<li>catkin_create_pkg &lt;作るパッケージの名前&gt; [使用するライブラリ...]</li>-c-c-c- 	<li>rospy: Pythonでノードを作るときに使用</li>-c-c-c- 	<li>パッケージを作ったら下にscriptsというディレクトリを作成-c-c-c-<ul>-c-c-c- 	<li>ここにノードとなるプログラムを置く</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<pre class="p1"><span style="color: #ffffff;"><span class="s1">$ cd ~/catkin_ws/src-c-c-c-</span>$ catkin_create_pkg mypkg rospy</span>-c-c-c-<span style="color: #ffffff;"> Created file mypkg/package.xml</span>-c-c-c-<span style="color: #ffffff;"> Created file mypkg/CMakeLists.txt</span>-c-c-c-<span style="color: #ffffff;"> Created folder mypkg/src</span>-c-c-c-<span style="color: #ffffff;"> Successfully created files in /home/ubuntu/catkin_ws/src/mypkg. Please adjust the values in package.xml.-c-c-c-<span class="s1">$ cd mypkg/-c-c-c-</span><span class="s1">$ mkdir scripts</span></span>-c-c-c-<span class="s1" style="color: #ffffff;">$ cd scripts/</span></pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>パブリッシャを作る</h2>-c-c-c-<ul>-c-c-c- 	<li>次のようなコードを書いてみましょう</li>-c-c-c- 	<li>ノード名が「count」、パブリッシャが「count_up」</li>-c-c-c-</ul>-c-c-c-<pre class="p1"><span class="s1" style="color: #ffffff;">#!/usr/bin/env python</span>-c-c-c-<span class="s1" style="color: #ffffff;">import rospy</span>-c-c-c-<span class="s1" style="color: #ffffff;">from std_msgs.msg import Int32</span>-c-c-c--c-c-c-<span class="s1" style="color: #ffffff;">if __name__ == '__main__': </span>-c-c-c-<span class="s1" style="color: #ffffff;"><span class="Apple-converted-space">    </span>rospy.init_node('count')</span>-c-c-c-<span class="s1" style="color: #ffffff;"><span class="Apple-converted-space">    </span>pub = rospy.Publisher('count_up', Int32, queue_size=1)</span>-c-c-c-<span class="s1" style="color: #ffffff;"><span class="Apple-converted-space">    </span>rate = rospy.Rate(10)</span>-c-c-c-<span class="s1" style="color: #ffffff;"><span class="Apple-converted-space">    </span>n = 0</span>-c-c-c-<span class="s1" style="color: #ffffff;"><span class="Apple-converted-space">    </span>while not rospy.is_shutdown():</span>-c-c-c-<span class="s1" style="color: #ffffff;"><span class="Apple-converted-space">        </span>n += 1</span>-c-c-c-<span class="s1" style="color: #ffffff;"><span class="Apple-converted-space">        </span>pub.publish(n)</span>-c-c-c-<span class="s1" style="color: #ffffff;"><span class="Apple-converted-space">        </span>rate.sleep()</span></pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>ノードの実行</h2>-c-c-c-<pre class="p1"><span class="s1" style="color: #ffffff;">$ rosrun mypkg count.py</span></pre>-c-c-c-<ul>-c-c-c- 	<li>rosnode listとrostopic listでノードとトピックの確認を</li>-c-c-c- 	<li>次にrostopic echoでcount_upからデータを取り出してみましょう</li>-c-c-c-</ul>-c-c-c-<pre class="p1"><span class="s1" style="color: #ffffff;">$ rostopic echo /count_up </span>-c-c-c-<span class="s1" style="color: #ffffff;">data: 1430</span>-c-c-c-<span class="s1" style="color: #ffffff;">---</span>-c-c-c-<span class="s1" style="color: #ffffff;">data: 1431</span>-c-c-c-<span class="s1" style="color: #ffffff;">---</span>-c-c-c-<span class="s1" style="color: #ffffff;">data: 1432</span>-c-c-c-<span class="s1" style="color: #ffffff;">---</span>-c-c-c-<span class="s1" style="color: #ffffff;">data: 1433</span></pre>-c-c-c-&nbsp;
