<h1 style="font-size: 250%;">ロボットシステム学</h1>-c-c-c-<h2>第6回</h2>-c-c-c-上田 隆一-c-c-c--c-c-c-2016年11月2日\@千葉工業大学-c-c-c--c-c-c-<!--nextpage-->-c-c-c-<h2>今日の内容</h2>-c-c-c-<ul>-c-c-c- 	<li>デバイスドライバを作る</li>-c-c-c- 	<li>次回はGPIOの操作に挑戦しますが、今回はPCの中で完結する話-c-c-c-<ul>-c-c-c- 	<li>仮想マシンでもOK</li>-c-c-c- 	<li>RaspbianとUbuntuでは少しやり方が違う</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>回路の例<a href="https://lab.ueda.asia/wp-content/uploads/2016/09/gpio25.jpg"><img class="alignright size-medium wp-image-1706" src="https://lab.ueda.asia/wp-content/uploads/2016/09/gpio25-300x225.jpg" alt="gpio25" width="300" height="225" /></a></h2>-c-c-c-<ul>-c-c-c- 	<li>GPIO25とGNDの間にLEDを接続-c-c-c-<ul>-c-c-c- 	<li>GPIO25: 22番ピン</li>-c-c-c- 	<li>GND: 39番ピン</li>-c-c-c- 	<li>LEDのアノード（足の長い方）をGPIO25に</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>抵抗はなくても特に問題ない-c-c-c-<ul>-c-c-c- 	<li>抵抗をつなぐとLEDに優しい</li>-c-c-c- 	<li>抵抗をつなぐ場合は200-300Ω程度（適当）</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>最初のコード</h2>-c-c-c-<ul>-c-c-c- 	<li>適当なディレクトリを作ってその中に</li>-c-c-c- 	<li>ファイル名は「myled.c」にしましょう</li>-c-c-c- 	<li>コードの中身-c-c-c-<ul>-c-c-c- 	<li>カーネルモジュールの初期化と後始末の関数を書く</li>-c-c-c- 	<li>マクロに関数名を与える</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">#include &lt;linux/module.h&gt;-c-c-c--c-c-c-static int __init init_mod(void)-c-c-c-{-c-c-c- return 0;-c-c-c-}-c-c-c--c-c-c-static void __exit cleanup_mod(void)-c-c-c-{-c-c-c-}-c-c-c--c-c-c-module_init(init_mod);-c-c-c-module_exit(cleanup_mod);-c-c-c-</span></pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>Makefileを書く</h2>-c-c-c-<ul>-c-c-c- 	<li>Makefileという名前のファイルを作って次のように書く</li>-c-c-c- 	<li><span style="color: #ff0000;">インデントはタブで</span></li>-c-c-c- 	<li>Makefileのごくごく簡単な説明-c-c-c-<ul style="font-size: 80%;">-c-c-c- 	<li>&lt;作りたいファイル or 行いたい処理&gt;: &lt;必要なファイル&gt;と書いてその下に実行するコマンドを書く</li>-c-c-c- 	<li>コロンの左側をターゲットと言う</li>-c-c-c- 	<li>makeと打つと最初に書いてあるターゲットの作成が試みられる</li>-c-c-c- 	<li>必要なファイルがないと、ないファイルのターゲットの処理が試みられる</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<pre class="p1"><span class="s1" style="color: #ffffff;">obj-m:= myled.o #オブジェクトファイルの名前を指定（拡張子はo）</span>-c-c-c--c-c-c-<span class="s1" style="color: #ffffff;">myled.ko: myled.c </span>-c-c-c-<span class="s1" style="color: #ffffff;"> make -C /usr/src/linux M=`pwd` V=1 modules #makeと打つと実行される</span>-c-c-c-<span class="s1" style="color: #ffffff;">clean:</span>-c-c-c-<span class="s1" style="color: #ffffff;"> make -C /usr/src/linux M=`pwd` V=1 clean #make cleanで実行</span></pre>-c-c-c-&nbsp;-c-c-c--c-c-c-<!--nextpage-->-c-c-c-<h2>コンパイルと実行-c-c-c-インストール</h2>-c-c-c-<ul>-c-c-c- 	<li>insmodでインストールできる</li>-c-c-c- 	<li>/dev/等にはまだ何も出てこない</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">$ make #Makefileとmyled.cが正しければこれでOK</span>-c-c-c-<span style="color: #ffffff;">$ ls #確認</span>-c-c-c-<span class="s1"><span style="color: #ffffff;">Makefile<span class="Apple-converted-space">  </span>Module.symvers<span class="Apple-converted-space">  </span>modules.order<span class="Apple-converted-space">  </span>myled.c<span class="Apple-converted-space">  </span>myled.ko<span class="Apple-converted-space">  </span>myled.mod.c<span class="Apple-converted-space">  </span>myled.mod.o<span class="Apple-converted-space">  </span>myled.o-c-c-c-$ sudo insmod myled.ko-c-c-c-</span></span><span style="color: #ffffff;"><span class="s1">$</span><span class="s2"> lsmod-c-c-c-</span><span class="s2">Module<span class="Apple-converted-space">                  </span>Size<span class="Apple-converted-space">  </span>Used by-c-c-c-</span><span class="s2">myled<span class="Apple-converted-space">                    </span>735<span class="Apple-converted-space">  </span>0 -c-c-c-...-c-c-c-</span><span class="s1">$</span><span class="s2"> sudo rmmod myled</span></span></pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>ログを吐くようにする</h2>-c-c-c-<ul>-c-c-c- 	<li>init_modとcleanup_modに「printk」という関数を追加</li>-c-c-c- 	<li>KERN_INFO: ログのレベルを示すマクロ</li>-c-c-c- 	<li>__FILE__: ソースコードのファイル名</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">static int __init init_mod(void)-c-c-c-{-c-c-c- printk(KERN_INFO "%s is loaded.\\n",__FILE__);-c-c-c- return 0;-c-c-c-}-c-c-c--c-c-c-static void __exit cleanup_mod(void)-c-c-c-{-c-c-c- printk(KERN_INFO "%s is unloaded.\\n",__FILE__);-c-c-c-}-c-c-c-</span></pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>動作確認</h2>-c-c-c-<ul>-c-c-c- 	<li>/var/log/messagesにカーネルモジュールの脱着が記録される</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">$ make-c-c-c-$ sudo insmod myled.ko-c-c-c-pi\@raspberrypi:~/myled_lecture $ tail /var/log/messages-c-c-c-...-c-c-c-Oct 23 11:42:48 raspberrypi kernel: [ 5639.631142] /home/pi/myled_lecture/myled.c is loaded.-c-c-c-$ sudo rmmod myled -c-c-c-pi\@raspberrypi:~/myled_lecture $ tail /var/log/messages-c-c-c-...-c-c-c-Oct 23 11:44:23 raspberrypi kernel: [ 5734.994105] /home/pi/myled_lecture/myled.c is unloaded.-c-c-c-</span></pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>ヘッダにモジュールの情報を記述</h2>-c-c-c-<ul>-c-c-c- 	<li>作者、何のモジュール化、ライセンスは何か、バージョン</li>-c-c-c- 	<li>ライセンス-c-c-c-<ul>-c-c-c- 	<li>基本的にはGPL（後日説明）</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">#include &lt;linux/module.h&gt;-c-c-c-MODULE_AUTHOR("Ryuichi Ueda");-c-c-c-MODULE_DESCRIPTION("driver for LED control");-c-c-c-MODULE_LICENSE("GPL");-c-c-c-MODULE_VERSION("0.1");-c-c-c--c-c-c-static int __init init_mod(void)-c-c-c-（以下略）-c-c-c-</span></pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>情報の確認</h2>-c-c-c-<ul>-c-c-c-<ul>-c-c-c- 	<li>modinfoというコマンドを利用</li>-c-c-c-</ul>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">$ modinfo myled.ko-c-c-c-filename: /home/pi/myled_lecture/myled.ko-c-c-c-version: 0.1-c-c-c-license: GPL-c-c-c-description: driver for LED control-c-c-c-author: Ryuichi Ueda-c-c-c-srcversion: 1278C67A0C932CB5D86D367-c-c-c-depends: -c-c-c-vermagic: 4.4.27-v7+ SMP mod_unload modversions ARMv7</span> -c-c-c-</pre>-c-c-c-<!--nextpage-->-c-c-c-<h2>デバイス番号の取得</h2>-c-c-c-<ul>-c-c-c- 	<li>解説は次ページ</li>-c-c-c-</ul>-c-c-c-<pre><span style="color: #ffffff;">#include &lt;linux/module.h&gt;-c-c-c-<span style="color: #ffff00;">#include &lt;linux/fs.h&gt;</span>-c-c-c-（中略）（MODULE_AUTHOR〜MODULE_VERSION）-c-c-c-<span style="color: #ffff00;">static dev_t dev;</span>-c-c-c--c-c-c-static int __init init_mod(void)-c-c-c-{-c-c-c-<span style="color: #ffff00;">	int retval;-c-c-c-	retval = alloc_chrdev_region(&amp;dev, 0, 1, "myled");-c-c-c-	if(retval &lt; 0){-c-c-c-		printk(KERN_ERR "alloc_chrdev_region failed.\\n");-c-c-c-		return retval;-c-c-c-	}-c-c-c-	printk(KERN_INFO "%s is loaded. major:%d\\n",__FILE__,MAJOR(dev));-c-c-c-</span>	return 0;-c-c-c-}-c-c-c--c-c-c-static void __exit cleanup_mod(void)-c-c-c-{-c-c-c-<span style="color: #ffff00;">	unregister_chrdev_region(dev, 1);-c-c-c-	printk(KERN_INFO "%s is unloaded. major:%d\\n",__FILE__,MAJOR(dev));</span>-c-c-c-}-c-c-c-</span><span style="color: #ffffff;">（略）-c-c-c-</span></pre>-c-c-c-<!--nextpage-->-c-c-c-<ul>-c-c-c- 	<li>alloc_chrdev_region: デバイス番号の取得-c-c-c-<ul>-c-c-c- 	<li>引数: dev（番号の入れ物）のアドレス、0番から1個マイナー番号が欲しい、デバイスの名前はmyled</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>unregister_chrdev_region: デバイス番号の解放-c-c-c-<ul>-c-c-c- 	<li>引数: dev、マイナー番号を1個返す</li>-c-c-c- 	<li>これを怠るとinsmodのたびに番号が増えていくので実験すると面白い</li>-c-c-c-</ul>-c-c-c-</li>-c-c-c- 	<li>MAJOR: devからメジャー番号を取り出すマクロ</li>-c-c-c-</ul>-c-c-c-<!--nextpage-->-c-c-c-<h2>メジャー番号の確認</h2>-c-c-c-&nbsp;-c-c-c-<pre><span style="color: #ffffff;">$ make-c-c-c-$ sudo insmod myled.ko-c-c-c-$ tail /var/log/messages-c-c-c-（略）-c-c-c-Oct 23 12:26:56 raspberrypi kernel: [ 492.932021] /home/pi/myled_lecture/myled.c -c-c-c-</span><span style="color: #ffffff;">is loaded. <span style="color: #ffff00;">major:243</span></span></pre>
